
<!DOCTYPE html>
 <html>
   <head> 
      <title>Paint</title>
      <link rel ="stylesheet" href="CSS.css"/>
     </head>
   <body style="margin: 0; touch-action: none" id="Body">
  <div id="preload" style="display: block">
    <input class="sizes" placeholder=" Width"/>
    <input class="sizes" placeholder=" Height" style="left: 20px;"/>
    <div id="start">Start Work</div>
    <img id="table"/>
     </div>
  <div id="content" style="display: none">
   <p id="messange" style="top: 0; z-index: 30"></p>
  </div>
 <script type="text/javascript">
  window.alert("Head Start")
  var connection = {}
  connection.body = document.getElementById("content")
  
  /* var connection = {
    date: "August 9, 2021",
    name: "Paint",
    version: "5.4",
    director: "Vsevolod Nitsenko",
    body: document.getElementById("content"),
    begin: function() {
     panel.colorEditor.strokeColors()
     connection.body.style.display = "block"
     document.getElementById("preload").style.display = "none"
     try {
     var width = eval( document.getElementsByClassName("sizes")[0].value )
     var height = eval( document.getElementsByClassName("sizes")[1].value )
     if(width && height) {
     canvas.resizeElement(width, height)
         }
     else { canvas.resizeElement(innerHeight-80, innerHeight-80) }
  
     bookmark_one.closeBook()
     bookmark_two.openBook();
     __sqr__ = createBackgroundGridImage( grid_width, 227, 218, 204, grid_Alpha);
       }
     catch {  }
        canvas.save()
        var e = canvas.element
        var top = (innerHeight - e.offsetHeight)/2
        if(top > 0) { e.style.marginTop = top + "px" }
        else { e.style.marginTop = "0px" }
         var left = (innerWidth - e.offsetWidth)/2
         if(left > 0) { e.style.marginLeft = left + "px" }
          else { e.style.marginLeft = "0px" }
     window.onresize()
       },
     extensionsAllow: false
     } */ window.alert("Head End")

   window.alert("Space Start")
     
  Array.prototype.delete = function(pos, place) {
    var arr = new Array()
     if(!place) {
     for(var i = 0; i < this.length-pos; i++) {
      arr.push(this[i])
         }
      }
     else {
        for(var i = 0; i < this.length; i++) {
         if(i != pos) { arr.push(this[i]) }
          }
        }
      return arr
    }
 Array.prototype.copy = function(F) {
    var res = new Array()
    for(var i = 0; i < this.length; i++) {
     var t = this[i]
     if(typeof F == "function") { t = F(t) }
     try { if(t.length) { t = t.copy(F) } } catch {}
     res[i] = t;
       }
  return res
   }
  
   HTMLElement.prototype.addResizeMap = function(f) {
     EventBase.setItem("resize-map",{ element: this, event: f })
    }
  
  HTMLElement.prototype.addListener = function(down, move, up, priorety) {
   if(!priorety) { priorety = 1 }
   else if(priorety < 0) { priorety = 1; console.warn("not allowed negative priorety!") }
   const object = this
   if(down && move && up) {
    EventBase.setItem("mousedown",{ object: object, event: function(e) { if( down(e) ) { return true } }, priorety: priorety })
    EventBase.setItem("mousemove",{ object: object, event: function(e) { if( move(e) ) { return true } }, priorety: priorety })
    EventBase.setItem("mouseup",{ object: object, event: function(e) { if( up(e) ) { return true } }, priorety: priorety })
     }
   };
  
   HTMLElement.prototype.useDropListener = function(callback) {
        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
         this.addEventListener(eventName, preventDefaults, false)
             })
             function preventDefaults (e) {
                   e.preventDefault()
                   e.stopPropagation()
              }
         this.addEventListener('drop', handleDrop, false)
             function handleDrop(e) {
                  let dt = e.dataTransfer
                  let files = dt.files
               handleFiles(files)
                 }
               function handleFiles(files) {
                files = [...files]
                files.forEach(callback)
               }
          };

  function mess(text) {
   document.getElementById("messange").innerHTML = text
    };
  
  function fix(a, b) { var res = a.toFixed(b); return eval(res) };
  
  function toElement(element, x, y) {
    var p = element.getClientRects()[0]
    x = x - p.x
    y = y - p.y
     return { x: x, y: y }
      }
  
  function onlyNumbers(text) {
     var res = ""
     for(var i = 0; i < text.length; i++) {
     for(var e = 0; e <= 9; e++) {
     if(text[i] == e.toString()) { res += text[i]; }
          }
        }
     if(res) { return eval(res) } else { return 0 }
    }
  
    function createBackgroundGridImage(width, R, G, B, A) {
       var context = document.createElement('canvas').getContext('2d')
       context.canvas.width= width
       context.canvas.height= width
       var imageData = context.getImageData(0,0, width, width)
       var Data = imageData.data
       function t(x) {
         x = x/4 
         if( x % width == 0) { return true }
         else if( x > width*(width-1) ) { return true }
        };
  
     for(var i = 0; i < Data.length; i+=4) {
      if( t(i) ) { 
       Data[i] = R
       Data[i+1] = G
       Data[i+2] = B
       Data[i+3] = A * 255
        }
      }; imageData.data = Data
  
    context.putImageData(imageData, 0, 0)
  
    var src = context.canvas.toDataURL()
   
       function dataToBlob(dataURI, dataTYPE) {
        var binary = atob(dataURI.split(',')[1]), array = [];
        for(var i = 0; i < binary.length; i++) array.push(binary.charCodeAt(i));
        return new Blob([new Uint8Array(array)], {type: dataTYPE});
               }
     return URL.createObjectURL( dataToBlob(src, 'image/png') )
  }; window.alert("Space End")
     window.alert("Base Start")
  class Move {
   constructor(element, parentElement, options) {
    const that = this
    this.active = false
    this.points = {}
    this.handle = function(e) {
    if(e.pageX==undefined || !e.pageY == undefined) {
     e.pageX = e.touches[0].pageX
     e.pageY =  e.touches[0].pageY
          }; return e
        }
    element.addListener(function(e) {
       if( !options || ( options && options(e) ) ) {
          e = that.handle(e)
          that.active = true
          document.body.style.cursor = "grabbing"
          that.points.x = e.pageX 
          that.points.y = e.pageY
          return true
            }
          }, function(e) {
            if(that.active) { 
             e = that.handle(e)
             if(parentElement) { element = parentElement }
             element.style.marginLeft = element.offsetLeft + (e.pageX - that.points.x) + "px"
             element.style.marginTop = element.offsetTop + (e.pageY - that.points.y) + "px"
             that.points.x = e.pageX
             that.points.y = e.pageY
            }
          }, function() { 
              document.body.style.cursor = "default"
              that.active = false
              that.points = {}
         }, 2)
      }
   }

  class EventDataBase  {
   constructor() {
     const that = this
     this.DataBase = []

     this.setItem = function(Class, item) {
      var t = { type: Class, item: item }
      that.DataBase.push(t)
        };

     this.getClass = function(Class) {
      var Result = []
      for(var i = 0; i < that.DataBase.length; i++) {
       if(that.DataBase[i].type == Class) { Result.push(that.DataBase[i].item) }
         }
     return Result
          };

      this.restoreDefault = function() { that.DataBase = [] }
     }
   };  var EventBase = new EventDataBase(); 
  
       EventBase.restore = function() {  this.active = {}  }  
       EventBase.restore();
  


  class Executor {
  constructor() {
   const that = this
   this.alt = false
   this.down = function(e) {
     var prioretyList = []
       var object = e.target
       var downs = EventBase.getClass("mousedown")
        for(var i = 0; i < downs.length; i++) {
         if(downs[i].object == object) { prioretyList.push(downs[i]); EventBase.active = object }
         }
     if(prioretyList.length) {

     function getPriorety() {
      var Res = [0, 0]
      for(var i = 0; i < prioretyList.length; i++) {
       if(prioretyList[i].priorety > Res[0]) { Res[1] = i }
         }; return Res[1]
      }

       function exe(t) {
          if( prioretyList[ t ].event(e) ) { return true }
          else if(prioretyList.length > 1 && !prioretyList[ t ].event(e) ) { prioretyList = prioretyList.delete(t, true); return false }
          else { return true }
           }  
       function find() {
        var t = getPriorety()
        if( !exe(t) ) { find() }
          }; find()

        }
     }
   this.move = function(e) {
     var prioretyList = []
      var moves = EventBase.getClass("mousemove")
      for(var i = 0; i < moves.length; i++) {
       if(moves[i].object == EventBase.active) { prioretyList.push(moves[i]) }
     }
     if(prioretyList.length) {

     function getPriorety() {
      var Res = [0, 0]
      for(var i = 0; i < prioretyList.length; i++) {
       if(prioretyList[i].priorety > Res[0]) { Res[1] = i }
         }; return Res[1]
      }

       function exe(t) {
          if( prioretyList[ t ].event(e) ) { return true }
          else if(prioretyList.length > 1 && !prioretyList[ t ].event(e) ) { prioretyList = prioretyList.delete(t, true); return false }
          else { return true }
           }  
       function find() {
        var t = getPriorety()
        if( !exe(t) ) { find() }
          }; find()

        }
  }
   this.up = function(e) {
    var prioretyList = []
     var ups = EventBase.getClass("mouseup")
      for(var i = 0; i < ups.length; i++) {
       if(ups[i].object == EventBase.active) { prioretyList.push(ups[i]); }
         }
     if(prioretyList.length) {

     function getPriorety() {
      var Res = [0, 0]
      for(var i = 0; i < prioretyList.length; i++) {
       if(prioretyList[i].priorety > Res[0]) { Res[1] = i }
         }; return Res[1]
      }

       function exe(t) {
          if( prioretyList[ t ].event(e) ) { return true }
          else if(prioretyList.length > 1 && !prioretyList[ t ].event(e) ) { prioretyList = prioretyList.delete(t, true); return false }
          else { return true }
           }  
       function find() {
        var t = getPriorety()
        if( !exe(t) ) { find() }
          }; find()
       EventBase.restore()
        }
    }
    this.handle = function(event) {
       if(event.y == undefined || event.x == undefined) {
        event.y = event.touches[0].pageY
        event.x = event.touches[0].pageX
         }; return event
       }
    this.changeBackground = function() {
     var s = 255 - (canvas.color[0] + canvas.color[1] + canvas.color[2])/3
     var transp = (1-canvas.color[3])/10 + 0.1
     background.style.backgroundColor = "rgba(" + s + "," + s + "," + s + "," + transp + ")"
       }
     }
   }; var executor = new Executor()
window.alert("Base End")

window.alert("Canvas Start")
class Canvas {
  constructor(width, height) {
  const that = this
  this.style = `
  border: 1px dotted;
  position: absolute;
  margin: 50px; `
  const Width = width
  const Height = height
  this.active = false
  this.canvas = document.createElement("canvas")
  this.element = document.createElement("div")
  that.element.style.position = "fixed"
  this.lasts = { x: NaN, y: NaN }
  this.color = [0, 0, 0, 0.5]
  this.width = 12;
 
   this.clear = function(s) {
    if(!s) { that.save() }
    var ctx = that.canvas.getContext("2d")
    ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height)
   };
  
   this.changeMarkup = function() {
    if(!that.canvas.style.backgroundImage) { that.canvas.style.backgroundImage = "url('" + __sqr__ + "')" }
    else { that.canvas.style.backgroundImage = "" } 
      };
  
    this.datas = []
      this.back = function() {
      if(that.datas.length > 1) {
      var data = that.datas[that.datas.length-1].data
      var ctx = that.canvas.getContext("2d")
      that.resizeElement(data.width, data.height)
      window.onresize()
      ctx.putImageData(data, 0, 0)
      that.datas = that.datas.delete(1)
         }
      };
    this.save = function() {
      var ctx = that.canvas.getContext("2d")
      var data = ctx.getImageData(0,0,ctx.canvas.width, ctx.canvas.height)
      that.datas.push({ data: data })
      try { panel.colorEditor.deletedColor = null } catch {}
     };
  
    this.getColor = function(t) {
     var transp = eval(that.color[3])
     var transperent = fix(transp, 2)
     var path = that.color[0] + "," + that.color[1] + "," + that.color[2]
     if(t) { path = "rgba(" + path + "," + transperent + ")" }
     else { path = "rgb(" + path + ")" } 
      return path
    };
  
   this.stDraw = function(e) {
      if(!that.active) {
      var canv = document.createElement("canvas")
      canv.style = that.style;  canv.style.border = "1px solid rgba(0,0,0,0)";
      canv.width = that.canvas.width;  canv.height = that.canvas.height
      that.element.append(canv) 
      that.active = canv
      var ctx = canv.getContext("2d")
      ctx.lineWidth = that.width
      ctx.strokeStyle = that.getColor();
      e = executor.handle(e)
      var cs = toElement(that.canvas, e.x, e.y)
       tools.brushes[tools.activeBrush].start({
          baseContext: that.canvas.getContext("2d"),
          activeContext: ctx,
          x: cs.x, y: cs.y
        }); mess("Canvas " + ", " + tools.brushes[tools.activeBrush].name)
      } else { that.ndDraw() }
    };
  
   this.mvDraw = function(e) {
     if(that.active) {
     e = executor.handle(e)
      var cs = toElement(that.canvas, e.x, e.y)
       tools.brushes[tools.activeBrush].move({ 
         baseContext: that.canvas.getContext("2d"),
         activeContext: that.active.getContext("2d"),
         lx: that.lasts.x, ly: that.lasts.y,
         x: cs.x, y: cs.y, originalEvent: e
       })
     that.lasts = { x: cs.x, y: cs.y }
     }
   };
  
   this.ndDraw = function(e) {
     if(that.active) {
       var src = that.active.toDataURL()
       var image = new Image()
       var ctx = that.canvas.getContext("2d")
       ctx.globalAlpha = that.color[3]
       try { tools.brushes[tools.activeBrush].end(that.lasts) } catch {}
        image.onload = function() { 
          ctx.drawImage(image, 0, 0)
          that.element.removeChild(that.active)
          that.active = false
        }
      image.src = src
      that.lasts = { x: NaN, y: NaN }
        }
      };
      var canv = that.canvas
      canv.width = Width
      canv.height = Height
      canv.addListener(that.stDraw, that.mvDraw, that.ndDraw)
      canv.style = that.style
      canv.className = "Canvas"
      this.element.append(canv);

    this.resizeElement = function(w, h, DisableCorrection) {
       var kw = Math.floor( w/grid_width) * grid_width
       var kh = Math.floor( h/grid_width) * grid_width
       if(DisableCorrection) { kw = w; kh = h }
       that.canvas.width = kw
       that.canvas.height = kh
       var m = onlyNumbers(this.canvas.style.margin)
       that.element.style.width = that.canvas.width +  m*2 + "px"
       that.element.style.height = that.canvas.height +  m*2 + "px"
      }; that.resizeElement(Width, Height)

    }
  }
window.alert("Canvas End")
window.alert("Bookmark Start")
 class bookmark {
  constructor(width, height, element, dropSize, inversion) {
  
   const style = `
    background-color: white;
    border: 1px solid; `
  
    const that = this
    this.DropSize = dropSize
    this.book = element
    this.element = document.createElement("div")
    var mark = that.element
    mark.style = style
    mark.style.width = width + "px"
    mark.style.height = height + "px"
    mark.style.display = "none"
    var Data = { biggest: width, lowest: height, orintation: "down" };
    if(width > height) { Data.biggest = height; Data.lowest = width; }
    if(!inversion && width < height) { Data.orintation = "right" }
    if(inversion && width < height) { Data.orintation = "left" }
    if(inversion && width > height) { Data.orintation = "up" }
    mark.style.borderRadius = Data.lowest/2 + "px"
    this.listeners = { open: function() {}, close: function() {} };
  
    this.openBook = function() {
      that.element.style.display = "none"
      that.book.style.display = "block"
      that.listeners.open()
      window.onresize()
     };
  
    this.closeBook = function() {
      that.book.style.display = "none"
      that.element.style.display = "block"
      that.listeners.close()
      window.onresize()
    };
  
  this.active = false
   this.take = function(e) {
     e = executor.handle(e)
     that.active = { sx: e.x, sy: e.y}
    };
  
   this.move = function(e) {
     e = executor.handle(e)
     if(that.active) {
      var progres = 0
      if(Data.orintation == "down") { 
        progres = e.y - that.active.sy
         if(progres > that.DropSize) {
          that.openBook();
          that.active = false; 
         }
       }
    if(Data.orintation == "up") {
     progres = that.active.sy - e.y
      if(progres > that.DropSize) {
       that.openBook();
       that.active = false; 
       }
     }
   if(Data.orintation == "right") {
    progres = e.x - that.active.sx
     if(progres > that.DropSize) {
      that.openBook();
      that.active = false; 
      }
    }
   if(Data.orintation == "left") { 
    that.active.sx - e.x
     if(progres > that.DropSize) {
      that.openBook();
      that.active = false; 
      }
   }
     var color = "rgba(" + canvas.color[0] +","+ canvas.color[1]+","+ canvas.color[2]+","
     color = color + Math.abs(progres)/that.DropSize + ")"
     that.element.style.backgroundColor = color
      }
   };
  
   this.drop = function() { that.active = false; that.element.style.backgroundColor="white" };  
   this.on_open = function(f) { that.listeners.open = f }
   this.on_close = function(f) { that.listeners.close = f };
   that.element.addListener(that.take, that.move, that.drop)
    }
  }
window.alert("bookmark end")
window.alert("Palet Start")
  class Palette {
     constructor(size) {
     const that = this
     const Size = size
     this.body = document.createElement("div")
       that.body.className = "paletteBody"
       that.body.style.width = 330 * size + "px"
       that.body.style.height = 190 * size + "px"
       that.body.style.borderRadius = 300 * size/8 + "px/" + 190 * size/2 + "px"
       that.body.ondblclick = function() {
       var margin = (that.body.offsetWidth - 255 * Size)/2
       for(var i = 0; i < 3; i++) {
       var left = that.colors[i].offsetLeft - margin + that.colors[i].offsetWidth/2
       canvas.color[i] = Math.round(left/Size)
           }
       panel.update()
         }
     this.colors = []
  
      this.changeColor = {
       start: function(element) {
        for(var i = 0; i < that.colors.length; i++) {
         if(that.colors[i] == element) { that.changeColor.active = "" + i; break }
           }
         that.changeLineWidth.use()
         },
       move: function(left) {
       var colorId = that.changeColor.active
       if(colorId) {
        var margin = (that.body.offsetWidth - 255 * Size)/2
        if(left > margin && left < that.body.offsetWidth - margin) {
         change( (left-margin)/Size )
          }
        else if(left < margin) { change(1) }
        else { change(255) }
        function change(position) {
           var Color = Math.round( position )
           var swch = that.colors[colorId]
            if(colorId == "0") {  /* swch.style.color = "rgb(" + Color + ",0,0)";*/ mess("color red: # " + Color); }
            else if(colorId == "1") {  /*swch.style.color = "rgb(0," + Color + ",0)";*/ mess("color green: # " + Color) }
            else { /* swch.style.color = "rgb(0,0," + Color + ")";*/ mess("color blue: # " + Color) }
            swch.style.marginLeft = (position * size - swch.offsetWidth/2 + margin) + "px"  
            canvas.color[colorId] = Color
            that.changeLineWidth.update(canvas.width)
            panel.update()
              }
            }
         },
       end: function() {
        that.changeColor.active = false
        that.changeLineWidth.hide()
          }
      };
  
      this.changeLineWidth = {
       start: function(e) {
        e = executor.handle(e)
        var vect = "left"
        if(toElement(that.body, e.x).x > that.body.offsetWidth/2) { vect = "right" }
          that.changeLineWidth.active = [e.x, canvas.width, vect]
          that.changeLineWidth.use()
        },
       move: function(e) {
        e = executor.handle(e)
        var abs = e.x
        if(that.changeLineWidth.active) {
          var width = that.changeLineWidth.active[1]
          if(that.changeLineWidth.active[2] == "right") {
            width = width + (abs - that.changeLineWidth.active[0])
         }
        else {  width = width + (that.changeLineWidth.active[0] - abs)  }
  
        if(width < 0) { width = 1 }; width = Math.round(width)
         mess("line width #" + width)
         that.changeLineWidth.update(width)
             }; panel.update()
           },
       end: function() {
        that.changeLineWidth.active = false
        that.changeLineWidth.hide()
           },
       hide: function() {
         that.changeLineWidth.hideP = true
         var speed = 0.02
         var ctx = that.lineWidth.getContext("2d")
         var a = 1
         function p() {
          if(a > 0 && that.changeLineWidth.hideP) {
            a = a - speed; ctx.globalAlpha = a; that.changeLineWidth.update(canvas.width); setTimeout(p, 25);
               } else {  that.changeLineWidth.hideP = false  }
             }; p()
         },
       use: function() {
         setTimeout(function() { that.changeLineWidth.hideP = false },0)
         var ctx = that.lineWidth.getContext("2d")
         ctx.globalAlpha = 1
           },
          update: function(width) {
          var ctx = that.lineWidth.getContext("2d")
          var k = canvas.color[0] + canvas.color[1] + canvas.color[2]
          //ctx.canvas.style.backgroundColor = "rgba(0,0,0," +  ( (k) / 255 * 3) + ")"
          ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
          canvas.width = width
          ctx.beginPath()
          ctx.arc(ctx.canvas.width/2, ctx.canvas.height/2, width/2, 0, Math.PI*2, false)
          ctx.fillStyle = canvas.getColor()
          ctx.fill()
            }
         }
      for(var i = 0; i < 3; i++) { 
      createSwch(i)
         }
      that.colors[0].style.marginTop = 12 * size + "px"
       function createSwch(i) {
        var swch = document.createElement("div")
         that.colors.push(swch)
         that.body.append(swch)
         swch.style.borderRadius = 12 * size + "px"
         swch.style.marginLeft = 30 * size + "px"
         swch.style.marginTop = 2 * size + "px"
         swch.style.width = 28 * size + "px"
         swch.style.height = 28 * size + "px"
         swch.className = "ColorSwch"
         swch.id = "" + i 
         swch.ondragstart = function() { return false }
         swch.addListener(function() { 
         that.changeColor.start(swch) 
          }, function(e) {
               e = executor.handle(e)
               var left = toElement(that.body, e.x, 0)
               that.changeColor.move(left.x)
            }, that.changeColor.end)
          }
        this.lineWidth = document.createElement("canvas")
        that.body.append(that.lineWidth)
        that.lineWidth.height = 8 * size
        that.lineWidth.width = 340 * size
        that.lineWidth.style.marginTop = 8 * size + "px"
        that.body.ondragstart = function() { return false }
        that.body.addListener(that.changeLineWidth.start,that.changeLineWidth.move,that.changeLineWidth.end);
  
        this.controls = document.createElement("div")
         var conts = that.controls
         conts.style.width = 120 * size + "px"
         conts.style.height = 35 * size + "px"
         conts.style.marginTop = 8 * size + "px"
         conts.style.marginLeft = 25 * size + "px"
         conts.onclick = function(e) {
           var x = toElement(this, e.x, 0).x
           if(x < this.offsetWidth/4) { tools.controlBrush(-1) }
           else if(x < this.offsetWidth*3/4) { bookmark_one.closeBook() }
           else { tools.controlBrush(1) }
         }; that.body.append(that.controls)
  
        this.button = document.createElement("div")
        this.button.className = "paletteButton"
        this.button.onclick = function() { panel.colorEditor.save() }
        this.button.style = "position: fixed; border: 1px solid; cursor: pointer;" 
        this.button.style.top = 0
        that.button.style.marginTop = 145 * size + "px"
        that.button.innerHTML = "save"
        that.button.style.textAlign = "center"
        that.button.style.padding = 4 * size + "px"
        that.button.style.width = 145 * size + "px"
        this.button.style.borderRadius = 20 * size + "px"
        that.body.append(that.button)
        that.button.style.left = 0;  that.body.button = that.button;
       } 
     }
window.alert("palet end")
window.alert("Panel Start")
  class Panel {
  constructor(width, savecode) {
  const that = this
  const Width = width
  this.active = false
  this.body = document.createElement("div")
  this.transperent = document.createElement("canvas")
  this.colors = document.createElement("div")
  that.colors.style.position = "fixed"
  that.body.append(that.colors)
  this.body.style.width = width*2 + "px"
  this.body.style.height = window.innerHeight + "px"
  this.body.className = "panelBody"
  this.body.style.maginTop = "-2px"
  this.body.style.position = "fixed"
  this.body.style.border = "2px solid"
  this.body.style.overflow = "hidden"
  this.body.style.backgroundColor = "rgba(255, 255, 255, 0.35)"
  this.body.addResizeMap(function(e) {
      e.style.borderRadius = Width + "px/" + innerHeight /2 + "px"
      e.style.marginLeft = innerWidth - Width + "px"
      e.style.height = innerHeight + "px"
      that.transperent.height = innerHeight
      that.colors.style.marginLeft = Width -55 + "px"
      that.colors.style.marginTop = innerHeight/Width * 20 + "px"
      that.update()
    })
  this.body.ondblclick=function() { 
      var data = canvas.getColor(true)
      navigator.clipboard.writeText(data)
      .then(() => {
       mess("active color coppied!")
       })
      .catch(err => {
      mess("failed to copy color: Browser don't support clipboard")
       })
   }
  this.transperent.height = innerHeight
  this.transperent.width = 20
  this.transperent.style.border = "1px dotted"
  this.transperent.style.marginLeft = Width - 25 + "px"
  that.body.append(this.transperent)
  this.t = 0
   this.start = function() {
    if(!that.active) {
     that.active = that.transperent.getContext("2d")
     }
  };
  
 this.move = function(y) {
   if(panel.active) {
    var ctx = panel.active
    ctx.fillStyle = canvas.getColor()
    ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height)
    ctx.clearRect(0,0,ctx.canvas.width,y)
    that.t = y
    var a = eval( (1 - that.t/innerHeight).toFixed(panel_alpha_width) )
     if(a > 1) { a = 1 }
     canvas.color[3] = a; canvas.canvas.getContext("2d").globalAlpha=a
     mess("Alpha " + a)
     }
   that.body.style.borderColor=canvas.getColor(); executor.changeBackground()
  };
 
 this.end = function() { if(panel.active) { that.active=false } };
 
 this.update = function() {
   that.t = (1-canvas.color[3]) * innerHeight
   var ctx = that.transperent.getContext("2d")
   ctx.fillStyle = canvas.getColor()
   ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height)
   ctx.clearRect(0,0,ctx.canvas.width,panel.t - innerHeight/20)
   that.body.style.borderColor=ctx.fillStyle
   if(tools.mode.active) { tools.mode.switch(0) }; executor.changeBackground()
    }
  this.transperent.addListener(that.start, function(e) { e=executor.handle(e); that.move(e.y) }, that.end);

  this.code = savecode
 
  that.colorEditor = {
    deletedColor: null,
    colors: [],
    max_length: 0,
    change_max_length: function(v) {
     editor.max_length = v
     localStorage.setItem(that.code + "max_length", v)
      },
  
    delete: function(element) {
    for(var i = 0;  i < editor.colors.length; i++) {
     var color = editor.colors[i]
     if(color.element == element) { 
        editor.deletedColor = color; 
        localStorage.setItem(that.code + color.n, "")
           break
         }
       }; editor.strokeColors()
     },
  
    canselDelete: function() {
     if(editor.deletedColor) {
     var color = editor.deletedColor
     if(color.n > editor.max_length) { editor.change_max_length(color.n+1) }
     localStorage.setItem(that.code + color.n, color.id)
        }; editor.strokeColors();
      },
  
    edit: function(rgb) {
       var c = []
     var i = 0; // start edit
     for(i = i; i < rgb.length; i++) { if(rgb[i] == "(") { break } }
     var f = ""
     for(i = i+1; i < rgb.length; i++) {
      if(rgb[i] != ")") {
       if(rgb[i] == ",") { c.push( eval(f) ); f = "" } else { f += rgb[i] }
             } else { break }
           } 
         c.push( eval( f )); return c
     },
  
    save: function() {
     editor.change_max_length(editor.max_length+1)
     var color = canvas.getColor(true)
     localStorage.setItem(that.code + editor.max_length, color)
     editor.strokeColors()
      },
  
    vote: function(element) {
    for(var i = 0;  i < editor.colors.length; i++) {
     var color = editor.colors[i]
     if(color.element == element) { 
        canvas.color = color.color.copy(); that.update()
          break
         }
       }
     },
  
    strokeColors: function() {
    that.colors.innerHTML = ""
    editor.loadColors()
    for(var i = 0; i < editor.colors.length; i++) {
     var color = editor.colors[i]
      var d = document.createElement("div")
       d.className="toog"
       d.style.backgroundColor = color.id
       d.id="t" + color.n
       d.onclick=function(e) {
         if(!e.altKey && !executor.alt) {
            that.colorEditor.vote(this)
             } else { that.colorEditor.delete(this) }
           }; 
        that.colorEditor.colors[i].element = d
        that.colors.append(d)
         }
      },
  
    loadColors: function() {
     editor.max_length = eval( localStorage.getItem(that.code + "max_length") )
     editor.colors = []
     for(var i = 0; i <= editor.max_length; i++) {
       var p = localStorage.getItem(that.code + i)
       if(p != "" && p != null) { editor.colors.push({ color: editor.edit(p), id: p, n: i }) }
         }
      }
    }; 
    var editor = that.colorEditor
  }
}
window.alert("panel end")
window.alert("Tools start")
  class Tools {
 constructor(size) {
  const that = this
   this.mode = {
    active: false,
    weapon: 0,
    max: document.createElement("div"),
    switch: function(n) {
     if(that.weapons[that.mode.weapon+n]) { exe(that.mode.weapon+n) } 
     else if(n > 0) { exe(0) }
     else { exe(that.weapons.length-1) }  
   function exe(x) {
     that.mode.weapon = x;
     that.mode.active = that.weapons[that.mode.weapon].name 
     var ctx = that.mode.min.getContext("2d")
     ctx.strokeStyle = canvas.getColor(true)
     ctx.lineWidth = 8
     ctx.lineCap = "round"
     ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height)
     ctx.stroke( that.weapons[that.mode.weapon].demo(ctx.canvas.width, ctx.canvas.height) )
     mess( that.mode.active )
      }
   },

  points: [],
  complete: function(event) {
   if(that.mode.active) {
     canvas.save()
     var draw = canvas.canvas.getContext("2d")
     draw.beginPath()
     draw.lineWidth = canvas.width
     draw.lineCap = "round"
     draw.strokeStyle=canvas.getColor(true)
     console.log(draw.strokeStyle)
      event( canvas.canvas.getContext("2d") ); that.mode.cansel()
      }
   },
 
   canvas: null,
   start: function(tool) {
    if(!that.mode.active) {
     if(tool) {
      that.mode.active = tool
    } else { that.mode.active = that.weapons[that.mode.weapon].name }
   var min = document.createElement("canvas")
   min.width = 110; min.height = 110;
   min.style = "background-color: rgba(255, 255, 255, 0.35); border: 1px dotted;"
   min.onclick = function() {
     that.mode.cansel()
    };
  
  that.mode.max.append(min)
  that.mode.min = min
  that.mode.switch(0)
  var draw = canvas.canvas.getContext("2d")
  that.mode.canvas = document.createElement("canvas")
  var canv = that.mode.canvas
  canv.width=draw.canvas.width
  canv.height=draw.canvas.height
  canv.style = canvas.style
  canvas.element.append(canv)
  var ctx = canv.getContext("2d")
   ctx.lineWidth = canvas.width
   ctx.fillStyle = canvas.getColor(true)
   canv.onclick=function(e) {
    that.mode.addPoint(e.layerX,e.layerY)
       }
     }
   },

  addPoint: function(x, y) {
   if(that.mode.active) {
    var ctx = that.mode.canvas.getContext("2d")
    ctx.beginPath()
    ctx.fillStyle = canvas.getColor(true)
    ctx.arc(x,y,canvas.width/2,0,2*Math.PI,false)
    ctx.fill()
    that.mode.points.push({ x: x, y: y })
    for(var i = 0; i < that.weapons.length; i++) {
      if(that.mode.active == that.weapons[i].name && that.mode.points.length >= that.weapons[i].points) {
        that.mode.complete(that.weapons[i].content); break
         }
       }
     }
  },
 
  cansel: function() {
   if(that.mode.canvas) {
    canvas.element.removeChild(that.mode.canvas)
    that.mode.points = []
    that.mode.active = false
    that.mode.canvas = null
    that.mode.max.removeChild(that.mode.min)
    that.mode.min = null
       }
     }
   }; this.weapons = []

  this.element = document.createElement("div")
  that.element.style = `border: 1px dotted; position: fixed;
    background-color: rgba(255,255,255, 0.75); margin-left: 15px`
  that.element.style.width = 210 * size + "px"
  that.element.style.height = 350 * size + "px"

  that.element.addResizeMap(function(e) {
  e.style.marginTop = innerHeight - 420 * size + "px"
   });

    that.mode.max.style.position = "fixed"
    that.mode.max.style.top = "0"
    that.mode.max.addResizeMap(function(e) {
    e.style.marginTop = (innerHeight-250) + "px"
    e.style.marginLeft = bookmark_two.element.offsetWidth + 10+ "px"
   }); connection.body.append(that.mode.max)
  

  that.controls = {
  head: document.createElement("div"),

  create: function(name, fun, ret) {
   var b = document.createElement("div")
   b.style.width = 190 * size + "px"
   b.style.paddingTop = 10 * size + "px"
   b.style.paddingBottom = 10 * size + "px"
   b.style.fontSize = 108 * size + "%"
   b.style.marginTop = 8 * size + "px"
   b.style.marginLeft = 10 * size + "px"

   b.className = "Tools_bu"
   b.innerHTML = name
    b.onclick = function() {  fun(this)  }
     if(!ret) {  that.controls.head.append(b) }
     else { return b }
      }
   }

  this.activeBrush = 0
  this.brushes = []
  this.controlBrush = function(n) {
   if(typeof n == "string") { 
   for(var i =0; i < that.brushes.length; i++) {
   if(that.brushes[i].name == name) { that.activeBrush = i; mess(n); return true }
      }
    }
   else if(typeof n == "number") {
   var res = true
   if(that.brushes[that.activeBrush + n]) {
      that.activeBrush += n
    }
   else { res = false }
       mess(that.brushes[that.activeBrush].name)
       return res
       }
    };
 
   this.image = {
   head: document.createElement("div"),
   frame: document.createElement("div"),
   events: [], 
   img: null,
   position: 0,
   execute: function() {
   if(that.image.img) {
   canvas.save()
   that.image.events[that.image.position].content(that.image.img, canvas.canvas.getContext("2d"))
          }
       },
   put: function(file) {
    if(!file) {
      var input = document.createElement("input")
      input.type = "file"
      input.oninput = function() {
        console.log(input.files[0])
        if(this.files[0]) { use(input.files[0]) }
       }; input.click()
    } else { use(file) }

   function use(file) {
     that.image.frame.innerHTML = ""
     var src = URL.createObjectURL(file)
     that.image.img = new Image()
     that.image.img.src =src
      var demoImage = new Image()
      demoImage.src = src
      demoImage.width = that.image.frame.offsetWidth
      demoImage.height = that.image.frame.offsetHeight
      that.image.frame.append(demoImage)
       }

    },
  
   switch: function() {
   var t = that.image.position
    if(that.image.events[t+1]) { that.image.position = t+1 } 
     else {
       that.image.position = 0
         }
      that.image.events[that.image.position].demo(that.image.frame)
       }
     }; that.image.frame.useDropListener(that.image.put)
 
   this.info = {
   head: document.createElement("div"),
    }
   this.content = 0
   this.switch = function(n) {
   var elements = [that.controls.head, that.image.head, that.info.head]
   if(elements[that.content + n]) {  exe(that.content+n) }
    else if(n > 0) { exe(0) }
    else if(n < 0) { exe(elements.length-1) }
    function exe(x) {
     that.content = x
     that.element.innerHTML = ""
     that.element.append(elements[that.content])
        }
      }
    var ImageGrid = Math.floor(35 * size)
    that.image.frame.style.width =  ImageGrid * 5 + "px"
    that.image.frame.style.height = that.image.frame.style.width
    that.image.frame.onclick = function() { that.image.switch() }
    that.image.frame.id = "image_frame"
    that.image.frame.style.border = "1px dotted"
    that.image.frame.style.overflow = "hidden"
    that.image.frame.style.backgroundImage="url('" + createBackgroundGridImage(ImageGrid, 150,150,150,0.2) + "')"
  
    that.image.head.append(that.image.frame)
    that.image.push = that.controls.create("Put Image", function() { that.image.put() }, true)
    that.image.draw = that.controls.create("Pust Image", that.image.execute, true)
    that.image.head.append(that.image.push)
    that.image.head.append(that.image.draw)
  
    that.switch(0)
    that.element.onclick = function(e) {
    if(e.target == this) {
    if(e.layerY > this.offsetWidth * 4/5) {
    if(e.layerX > this.offsetWidth * 3/4) { that.switch(1) }
    else if(e.layerX < 1/4 * this.offsetWidth) { that.switch(-1) }
            }
         }
      }
    that.info.head.style = `font-family: ui-serif; font-style: oblique; 
      margin-left: 10px;`
    that.info.head.style.marginTop = 10 * size + "px"
    that.info.head.style.fontSize = 120 * size + "%"
        that.info.head.innerHTML = `<br/> <br/>Support email: 14box14@gmail.com <br/> 
          also see this:`
 
     var dv = that.controls.create("Github", function() { window.open("https://github.com/VsevolodNitsenko") }, true)
     dv.style.marginLeft = "0px"
     that.info.head.append(dv);

  that.weapons.push({ name: "circle", content: function() {
      var a = that.mode.points[0].x - that.mode.points[1].x
      var b = that.mode.points[0].y - that.mode.points[1].y
      var Radius = Math.sqrt(a * a + b * b)
      var draw = canvas.canvas.getContext("2d")
      draw.arc(that.mode.points[0].x,that.mode.points[0].y,Radius,0,2 * Math.PI,false)
      draw.stroke(); } , points: 2, demo: function(width, height) {
        var p = new Path2D()
        p.arc(width/2, height/ 2, width/2 -15, 0, 2*Math.PI, false)
        return p
           }
       });
    that.weapons.push({ name: "line", content:  function() {
      var draw = canvas.canvas.getContext("2d")
      draw.moveTo(that.mode.points[0].x,that.mode.points[0].y)
      draw.lineTo(that.mode.points[1].x,that.mode.points[1].y)
      draw.stroke(); }, points: 2, demo: function(width, height) {
         var p = new Path2D()
         p.moveTo(width / 4, height * 4/5)
         p.lineTo(width * 4/5, height / 5)
         return p
         }
      });
   that.weapons.push({ name: "triangle", content: function triangle() {
       var draw = canvas.canvas.getContext("2d")
       for(var i = 0; i < 2; i++) {
         draw.moveTo(that.mode.points[i].x,that.mode.points[i].y)
         draw.lineTo(that.mode.points[i+1].x,that.mode.points[i+1].y)
        }
       draw.moveTo(that.mode.points[2].x,that.mode.points[2].y)
       draw.lineTo(that.mode.points[0].x,that.mode.points[0].y)
       draw.stroke(); }, points: 3, demo: function(width, height) {
        var p = new Path2D()
          p.moveTo(width/2, height /5)
          p.lineTo(width * 4/5, height * 3/4) // line 1
          p.moveTo(width *4/5, height * 3/4)
          p.lineTo(width /5, height * 3/4) // line 2
          p.moveTo(width /5, height * 3/4)
          p.lineTo(width/2, height/5) // line 3
          return p
          }
       });
  that.weapons.push({ name: "square", content: function() {
    var draw = canvas.canvas.getContext("2d")
    for(var i = 0; i < 3; i++) {
     draw.moveTo(that.mode.points[i].x,that.mode.points[i].y)
     draw.lineTo(that.mode.points[i+1].x,that.mode.points[i+1].y)
       }
     draw.moveTo(that.mode.points[3].x,that.mode.points[3].y)
     draw.lineTo(that.mode.points[0].x,that.mode.points[0].y)
     draw.stroke(); }, points: 4, demo: function(width, height) {
         var p = new Path2D()
         p.moveTo(width/5, height/5)
         p.lineTo(width * 4/5, height/5)
         p.moveTo(width * 4/5, height/5)
         p.lineTo(width * 4/5, height*4/5)
         p.moveTo(width * 4/5, height*4/5)
         p.lineTo(width/5, height*4/5)
         p.moveTo(width/5, height*4/5)
         p.lineTo(width/ 5, height/5)
          return p   
         }
      });
   that.brushes.push({ name: "Default line", 
     start: function(event) {  
        event.activeContext.lineCap = "round"
        event.activeContext.moveTo(event.x, event.y)
        event.activeContext.lineTo(event.x, event.y)
        event.activeContext.stroke()
   },
     move: function(event) {
      var path = new Path2D()
      path.moveTo(event.lx, event.ly)
      path.lineTo(event.x,event.y)
      event.activeContext.stroke( path )
       }, end: function() { canvas.save() }
    });
  
   that.brushes.push({ name: "Eraser",
    start: function(event) { canvas.save() },
    move: function(event) {
    var width = canvas.width
    var draw = canvas.canvas.getContext("2d")
    draw.beginPath()
    draw.save()
    draw.arc(event.x,event.y,width,0,2 * Math.PI,false)
    draw.clip()
    canvas.clear(true)
    draw.restore()
         }, end: function() {}
       });
    that.brushes.push({ name: "Finger Width", 
      start: function(event) {  
        event.activeContext.lineCap = "round"
        event.activeContext.moveTo(event.x, event.y)
        event.activeContext.lineTo(event.x, event.y)
        event.activeContext.stroke()
        },
      move: function(event) {
       var path = new Path2D()
       path.moveTo(event.lx, event.ly)
       path.lineTo(event.x,event.y)
      if(event.originalEvent.touches && event.originalEvent.touches[0]) {
       var t = event.originalEvent.touches[0]
       if(t.radiusX >= t.radiusY) { event.activeContext.lineWidth= t.radiusX }
       else if(t.radiusX < t.radiusY) { event.activeContext.lineWidth= t.radiusY }   
             } event.activeContext.stroke( path )
           }, end: function() { canvas.save() }
        });

    that.brushes.push({ name: "Decoration (0, 20)", 
      start: function(event) {  
        event.activeContext.lineCap = "round"
        event.activeContext.moveTo(event.x, event.y-20)
        event.activeContext.lineTo(event.x, event.y)
        event.activeContext.stroke()
        },
      move: function(event) {
       var path = new Path2D()
       path.moveTo(event.lx, event.ly-20)
       path.lineTo(event.x,event.y)
       event.activeContext.stroke( path )
           }, end: function() { canvas.save() }
        });

    that.brushes.push({ name: "Color Select",
       start: function(event) {
       event = executor.handle(event)
       var data = event.baseContext.getImageData(event.x, event.y, 1, 1).data
       canvas.color[0] = data[0]
       canvas.color[1] = data[1]
       canvas.color[2] = data[2]
       canvas.color[3] = Math.floor(data[3]/255)
       panel.update()
          }, move: function() {}
       });
    that.brushes.push({  name: "fill Pixels (range: 10)", 
          start: function(event) {
          var range = 10
          canvas.save()
          event = executor.handle(event)
          var ctx = event.baseContext
          var data = ctx.getImageData(0,0, ctx.canvas.width, ctx.canvas.height)
          var pixel = ctx.getImageData(event.x, event.y, 1,1).data
          var Data = data.data;
          function Equal(arr1, arr2) {
           var Res = 0
           for(var i = 0;  i < arr1.length; i++) {
             if( equal(arr1[i], arr2[i], range) ) { Res++ }
               }
            if(Res == arr1.length) { return true }
            }
          function equal(n1, n2, rn) {
           if(n1-rn <= n2 && n1 + rn >= n2) { return true }
             }
          for(var i = 0; i < Data.length; i+=4) {
            var p = [ Data[i] , Data[i+1] , Data[i+2] , Data[i+3] ]
            if( Equal(p, pixel) ) {
               Data[i] = canvas.color[0];
               Data[i+1] = canvas.color[1]; 
               Data[i+2] = canvas.color[2]; 
               Data[i+3] = canvas.color[3]*255;
                 }
               }; ctx.putImageData(data, 0, 0);
             },
          move: function() {  },
          end: function() {  }
        });
     
      that.image.events.push({ content: function(image, canvasContext) {
            image.ondragstart = function() { return false }
            image.style="position: fixed; z-index: 10; opacity: 0.8"
            image.style.marginLeft = canvas.element.offsetLeft+canvas.canvas.offsetLeft + "px"
            image.style.marginTop = canvas.element.offsetTop +canvas.canvas.offsetTop+ "px"
            image.active = false
            image.addListener(function(e) { 
             e = executor.handle(e)
             var cs = toElement(image, e.x, e.y)
             image.active=[cs.x, cs.y]
             },
            function(e) {
              if(image.active) { e = executor.handle(e);
                 image.style.marginLeft = e.x-image.active[0]+"px"
                 image.style.marginTop = e.y-image.active[1]+"px"
                 }
              }, function () { image.active=false })
            image.onclick = function(e) {
            var cs = toElement(canvas.canvas, this.offsetLeft, this.offsetTop)
            canvasContext.drawImage(this, cs.x-1, cs.y-1)
            document.body.removeChild(this)
               }; document.body.append(image);       
          },
          demo: function(dv) { dv.style.border="1px solid" } 
       });  
     that.image.events.push({ content: function(image) {    
            var height = image.naturalHeight * (canvas.canvas.width / image.naturalWidth)
            canvas.resizeElement(canvas.canvas.width, height, true)
            canvas.canvas.getContext("2d").drawImage(image,0,0,canvas.canvas.width,canvas.canvas.height)
            }, demo: function(dv) { 
                dv.style.border="1px dotted"
                dv.style.borderLeft="2px solid"
                dv.style.borderRight="2px solid"
               } 
        });
     that.image.events.push({ content: function(image) {
          var top = 0;
          var left = 0;
          for(var x = left; x < canvas.canvas.width; x+= image.naturalWidth) {
           for(var y = top; y < canvas.canvas.height; y+= image.naturalHeight) { 
              canvas.canvas.getContext("2d").drawImage(image,x,y) }
                }
               }, demo: function(dv) { dv.style.border="1px dotted" }  
           });
     that.image.events.push({ content: function(image) {
         canvas.resizeElement(image.naturalWidth, image.naturalHeight, true)
         canvas.canvas.getContext("2d").drawImage(image, 0,0)
           }, demo: function(dv) { dv.style.border="2px solid" }  
        });
     }
  };
window.alert("Tools end ")
window.alert("Building..")

 var __sqr__ = ""
 const canvas_width = innerHeight-80
 const panel_width = 110 //90
 const palette_size = 0.78
 const grid_width = 25 //Math.round(canvas_width/38)
 const panel_alpha_width = 2
 const grid_Alpha = 0.75 //0.65
 const activeButtonColor = "rgba(185,158,153,0.2)"
  
  var background = document.createElement("div")
  background.style.position = "fixed"
  background.style.top = "0"
  connection.body.append(background)
    background.addResizeMap(function(e) {
    e.style.width = innerWidth + "px"
    e.style.height = innerHeight + "px"
   })
  var canvas = new Canvas(canvas_width, canvas_width)
   canvas.save()
   connection.body.append(canvas.element)
   var move = new Move(canvas.canvas, canvas.element, function(e) { 
    if(e.altKey || executor.alt) { return true }
   })
    
  var palette = new Palette(palette_size)
   palette.body.style.top = "0"
   palette.body.addResizeMap(function(e) {
    var left = (innerWidth - e.offsetWidth)/2
    e.style.marginLeft = left + "px"
    e.style.marginTop = "0px"
    e.button.style.marginLeft = 140 * palette_size + left + "px"
   })
  connection.body.append(palette.body)
  
    var panel = new Panel(panel_width, "paint_colors_")
    panel.body.style.zIndex = "10"
    panel.body.style.top = "0"
    connection.body.append(panel.body)


  var tools = new Tools(0.95)
  tools.element.style.display = "none"
  tools.element.style.top = "0"
  connection.body.append(tools.element)
  
  tools.controls.create("Grid", function(e) { 
    canvas.changeMarkup(e)
  })
  tools.controls.create("Clear", canvas.clear)
  tools.controls.create("Save", function() {  
   var a = document.createElement("a")
   a.href = canvas.canvas.toDataURL(); 
   a.download = "Image"
   a.click()
   })
  tools.controls.create("Cansel", function() { 
  if(!panel.colorEditor.deletedColor) {
   canvas.back()
  } else {
   panel.colorEditor.canselDelete()
      }
    })
  tools.controls.create("Switch", function() { bookmark_two.closeBook(); tools.mode.start() })
  tools.controls.create("Move", function(e) { 
  if(executor.alt) { executor.alt = false; e.style.backgroundColor = "" }
  else { executor.alt = true; e.style.backgroundColor = activeButtonColor  }
    })
  var bookmark_one = new bookmark(100, 28, palette.body, 80)
   bookmark_one.element.style.position = "fixed"
   bookmark_one.element.style.top="0px"
   bookmark_one.element.addResizeMap(function(e) {
   e.style.maginTop = "0px"
   e.style.marginLeft = (innerWidth - e.offsetWidth)/2 + "px"
     })
  bookmark_one.element.onclick = function(e) {
   if(toElement(bookmark_one.element, e.x, 0).x > this.offsetWidth/2) { tools.controlBrush(1) }
   else { tools.controlBrush(-1); }
   }
  connection.body.append(bookmark_one.element)

  var bookmark_two = new bookmark(28, 135, tools.element, 80)
  bookmark_two.element.style.position = "fixed"
  bookmark_two.element.addResizeMap(function(e) {
   e.style.marginLeft = "0px"
   e.style.marginTop = (innerHeight-260) + "px"
     })
   bookmark_two.element.addListener(bookmark_two.take, bookmark_two.move, bookmark_two.drop)
   bookmark_two.element.style.top = "0px"
   bookmark_two.on_open(function() { tools.mode.cansel() })
   bookmark_two.element.style.display = "block"
   bookmark_two.element.onclick = function(e) {
       var l = e.layerY
       if(l > this.offsetHeight/2) { l = 1 } else { l = -1 }
       if(tools.mode.active) { tools.mode.switch(l) }
         else { tools.mode.start() }
   }
  connection.body.append(bookmark_two.element);
    

  document.getElementById("start").addResizeMap(function(e) {
  e.style.marginLeft = (innerWidth - e.offsetWidth)/2 + "px"
  e.style.marginTop = (innerHeight/2 + 20) + "px"
    })
  document.getElementsByClassName("sizes")[0].addResizeMap(function(e) {
  e.style.marginLeft = (innerWidth - e.offsetWidth)/2 + 45 + "px"
  e.style.marginTop = (innerHeight/2) - 85 + "px"
    })
  document.getElementsByClassName("sizes")[1].addResizeMap(function(e) {
  e.style.marginTop = (innerHeight/2 - 30) + "px"
  e.style.marginLeft = (innerWidth - e.offsetWidth)/2 + "px"
    })
  document.getElementById("preload").addResizeMap(function(e) {
   e.style.height = innerHeight + "px"
    })
  document.getElementById("table").addResizeMap(function(e) {
   e.style.marginTop = innerHeight/2 - 170 + "px"
   e.style.marginLeft = (innerWidth - e.offsetWidth)/2 + "px"
    }); 
 
   document.addEventListener("mousedown",executor.down)
   document.addEventListener("mousemove",executor.move)
   document.addEventListener("mouseup", executor.up)
  
   document.ontouchstart = function(e) { executor.down(e) }
   document.ontouchmove =  function(e) { e.preventDefault(); executor.move(e) }
   document.ontouchend = function(e) { executor.up(e) }


  
   window.onresize = function() {
    var events = EventBase.getClass("resize-map")
     for(var i = 0; i < events.length; i++) {
      events[i].event(events[i].element)
       }
     }
   window.onload = function() {   window.onresize()  }
window.alert("Extensions")
    // How to Name Extensions?
    // Create files like "extension-number.txt"
    // they will loading from zero to the biggest number.


    function upload(i) {
    var script = document.createElement("script")
    script.src = "extension-" + i + ".txt"
    document.body.append(script)
    script.onload = function() {
     console.warn("extension (" + i + ") is connected.")
     upload(i+1)
        }
    script.onerror = function() { 
     console.warn("extension (" + i + ") is not found.")
     document.body.removeChild(this)
        }
      }      
     if(connection.extensionsAllow) { upload(0) }
  

  // How to Write Extensions?
  
   /* Tools (Brushes) List Structure: 
       {  name: "", 
          start: function(event) {  },
          move: function(event) {  },
          end: function() { canvas.save() }
        }
  
     Start Event Options: {
         baseContext: Real Canvas,
         activeContext: fake Canvas,
         x: new point-X, y: now point-Y
       }
  
     Move Event Options: 
       { 
         baseContext: Real Canvas,
         activeContext: fake Canvas,
         lx: last point-X, ly: last point-Y,
         x: now point-X, y: now point-Y,
         originalEvent: mousemoveEvent / touchmoveEvent
       };
  
     Add Extension: tools.controls.brushes.push({ extension })
    */
  
   /* Tools (Figures) List Structure: 
        { name: "",
          points: Number,
          content: function(canvasContext, pointArray) {  } ,
          demo: function(width, height) { return Path2D }
         }
     Add Extension: tools.mode.weapons.push({ extension })
   */
  
   /* Tools (Images) List Structure:
          content: function(image, canvasContext) { canvasContext.drawImage(image) },
          demo: function(dv) { dv.style.border="" } 
     };
    Add Extension: tools.image.events.push({ extention })
    */
  window.alert("Done!")
 </script>



  <script type="text/javascript" id="Script-Head"></script>
  <script type="text/javascript" id="Code-Space"></script>
  <script type="text/javascript" id="Base-Elements"></script>
  <script type="text/javascript" id="Canvas-Object"></script>
  <script type="text/javascript" id="Bookmark-Object"></script>
  <script type="text/javascript" id="Palette-Object"></script>
  <script type="text/javascript" id="Panel-Object"></script>
  <script type="text/javascript" id="Tools-Object"></script>
  <script type="text/javascript" id="Build-Project"></script>
  <script type="text/javascript" id="Extensions-About"></script>
   </body>
 </html>